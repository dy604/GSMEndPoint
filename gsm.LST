C51 COMPILER V9.01   GSM                                                                   12/06/2016 11:26:04 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE GSM
OBJECT MODULE PLACED IN gsm.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE gsm.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /************************************************************
   2          ˵
   3          кgprsģҵźţͻָķ
   4          1.Լ51ƬĴ1ӵGSM232ӿ
   5          2.ҵǰ#define˵޸ĺԼĵƬ.
   6          3.ʹҳhttp://www.ip138.com/ѯԼipַ
   7          4.ڹҵ Թ\socket tool.exe 򿪣Эͣtcpipַض˿Ĭϡ
   8          5.س
   9          6.ģ,ȴźŵ˸ģֻյģ鷢Ϣ
  10          
  11          *************************************************************/
  12          #include <REG51.H>
  13          #include <string.h>
  14          
  15          #define uchar unsigned char
  16          #define uint unsigned int
  17          
  18          //51ƬľС
  19          #define FOSC_110592M
  20          //#define FOSC_12M
  21          
  22          
  23          //ڱ浥Ƭյģ鷢ATָͨЩָƬжģ״̬
  24          uchar GsmRcv[30] = {0};
  25          uchar GsmRcvAt[30] = {0}; 
  26          uchar GsmRccAt[30] = {0}; 
  27          uchar GsmRcvCnt = 0;   //ַ
  28          uchar GsmAtFlag = 0;   //ǰжǷվ֮з
  29          uchar GsmJiFlag = 0;   //ǰνν
  30          uchar GsmQiFlag = 0;   //ʶӵǰַʼȡ
  31          uchar GsmLiFlag = 0;   //֮ʼݽ
  32          uchar CanRead = 0;
  33          uchar count = 0;
  34          static uchar second = 0;   //
  35          unsigned int tcount;
  36             
  37          //ע⣬۽յźŻǷźţжϷ
  38          /*ʼ򣨱ʹã޷շγ򽫻ʹöʱ1*/
  39          void SerialInti()//ʼ򣨱ʹã޷շ
  40          {
  41   1              TMOD=0x22;//ʱ1ģʽ2:8λԶضʱ
  42   1      
  43   1      #ifdef FOSC_12M            //ݾСòֵͬʼ
                      TH1=0xf3;//װֵ2400
                      TL1=0xf3;       
              #else   
  47   1              TH1=0xfd;//װֵ9600
  48   1              TL1=0xfd;
  49   1      #endif //end of SOC_12M
  50   1      
  51   1              TH0=0x06;
  52   1          TL0=0x06;
  53   1              
  54   1              TR1=1;//򿪶ʱ
  55   1              TR0=1;
C51 COMPILER V9.01   GSM                                                                   12/06/2016 11:26:04 PAGE 2   

  56   1              SM0=0;//ôͨѶģʽ10Ϊһͣʿɱ䣬ɶʱ1ʿƣ
  57   1              SM1=1;//(ͬ)ڴģʽ£ʱһξͷһλ
  58   1              REN=1;//нλҪsm0sm1ٿ
  59   1              ET0=1;
  60   1              EA=1;//ж
  61   1              ES=1;//пж     
  62   1      }
  63          
  64          void Uart1Send(uchar c)
  65          {
  66   1              SBUF=c;
  67   1              while(!TI);//ȴźţTI=1
  68   1              TI=0;   
  69   1      }
  70          
  71          //пchar飬ֹ/0ֹͣ
  72          void Uart1Sends(uchar *str)
  73          {
  74   1              while(*str!='\0')
  75   1              {
  76   2                      SBUF=*str;
  77   2                      while(!TI);//ȴźţTI=1
  78   2                      TI=0;
  79   2                      str++;
  80   2              }
  81   1      }
  82          
  83          //ʱ1sӣʱĻ׼...
  84          void DelaySec(int sec)
  85          {
  86   1              uint i , j= 0;
  87   1      
  88   1              for(i=0; i<sec; i++)
  89   1              {
  90   2                      for(j=0; j<65535; j++)
  91   2                      {       
  92   3                      }
  93   2              }
  94   1      }
  95          
  96          void t0(void) interrupt 1 using 0 
  97          {       
  98   1              tcount++;
  99   1      
 100   1          if(tcount==4000)
 101   1              {
 102   2                      tcount=0;
 103   2                      if (GsmLiFlag == 1) 
 104   2                      {
 105   3                              second++;
 106   3                              if(second == 1)
 107   3                              {
 108   4                                      Uart1Sends("AT+CIPSEND\r\n");
 109   4                              } 
 110   3                              else if (second == 4) 
 111   3                              {
 112   4                                      Uart1Sends("abc123\r\n");       //ʱԶݣࣩ֮
 113   4                              }
 114   3                              else if (second == 5) 
 115   3                              {
 116   4                                      Uart1Send(0x1a);//0x1a
 117   4                              }
C51 COMPILER V9.01   GSM                                                                   12/06/2016 11:26:04 PAGE 3   

 118   3                              else if (second == 8) 
 119   3                              {
 120   4                                      second = 0;
 121   4                              }
 122   3                      }
 123   2              }
 124   1      }
 125          
 126          /*ͨѶжϣշɽж*/
 127          void Serial_interrupt() interrupt 4 
 128          {
 129   1              uchar i = 0;
 130   1      
 131   1              if(RI == 1)     //յϢ
 132   1              {
 133   2      
 134   2                      RI=0;//жź㣬ʾ
 135   2      
 136   2                      if (SBUF == '[') 
 137   2                      {
 138   3                              GsmQiFlag = 1;
 139   3                      }
 140   2      
 141   2                      if (GsmJiFlag == 0) 
 142   2                      {
 143   3                              GsmRcv[GsmRcvCnt] = SBUF;
 144   3                              GsmRcvCnt++;
 145   3                              //յATָATָ0x0a 0x0dβġжϣڽյĹǷյ0x0a 0x0d
 146   3                              if( GsmRcvCnt >= 2 && (GsmRcv[GsmRcvCnt-2] == 0x0d && GsmRcv[GsmRcvCnt-1] == 0x0a) )
 147   3                              {
 148   4                                      //һյ0x0a 0x0dͽݱûжϡ                       
 149   4                                      for(i=0; i<GsmRcvCnt; i++)
 150   4                                      {
 151   5                                              GsmRcvAt[i] = GsmRcv[i];                                 
 152   5                                              GsmRcv[i] = 0;  
 153   5                                      }
 154   4                                      GsmRcvCnt = 0;
 155   4                                      GsmAtFlag = 1;//յatָͨ־λ1֪ȥжˡ
 156   4                              }
 157   3                              else if(GsmRcvCnt >= 30)//Ϊڴޣյ50ַûп0x0a 0x0dĻ¿ʼհɡ
 158   3                              {
 159   4                                      GsmRcvCnt = 0;
 160   4                              }
 161   3                      } 
 162   2                      else
 163   2                      {
 164   3                              if (GsmQiFlag == 1) 
 165   3                              {
 166   4                                       GsmRcv[GsmRcvCnt] = SBUF;
 167   4                                       GsmRcvCnt++;
 168   4                                       if(GsmRcvCnt >= 2 && (GsmRcv[GsmRcvCnt-2] == '#' ||  GsmRcv[GsmRcvCnt-1] == '#'))
 169   4                                       {
 170   5                                              for(i=0; i<GsmRcvCnt; i++)
 171   5                                              {
 172   6                                                      GsmRccAt[i] = GsmRcv[i];
 173   6                                                      GsmRcv[i] = 0;  
 174   6                                              }
 175   5                                              GsmRcvCnt = 0;
 176   5                                              GsmQiFlag = 0;
 177   5                                              CanRead = 1;     //տָ
 178   5                                      }
 179   4                                      else if(GsmRcvCnt >= 30)//Ϊڴޣյ50ַûп0x0a 0x0dĻ¿ʼհɡ
C51 COMPILER V9.01   GSM                                                                   12/06/2016 11:26:04 PAGE 4   

 180   4                                      {
 181   5                                              GsmRcvCnt = 0;
 182   5                                      }
 183   4                              }
 184   3                      }
 185   2                      
 186   2              }
 187   1      }
 188          
 189          
 190          
 191          void main()
 192          {
 193   1              uchar i = 0;
 194   1              SerialInti();
 195   1      
 196   1      //жǷ
 197   1              GsmAtFlag = 0;
 198   1              while(GsmAtFlag == 0)
 199   1              {
 200   2                      Uart1Sends("ATI\r\n");//sim300
 201   2                      DelaySec(1);//ʱ1
 202   2              }
 203   1              GsmAtFlag = 0;
 204   1      
 205   1              //ź
 206   1              while(1)
 207   1              {
 208   2                      Uart1Sends("AT+COPS?\r\n");
 209   2                      DelaySec(2);//ʱ1
 210   2                      while(GsmAtFlag == 0);
 211   2                      if(strstr(GsmRcvAt, "CHN-UNICOM") )//Ƿյ CHINA MOBILE Ϣյ֤ˣ
             -йƶCHINA;йͨCHN-UNICOM
 212   2                      {
 213   3                              Uart1Sends("AT+CIPCLOSE\r\n");  //ڹرTCP/UDP
 214   3                              DelaySec(1);
 215   3                              Uart1Sends("AT+CIPRXGET=0\r\n");         //Զ
 216   3                              DelaySec(1);
 217   3                              Uart1Sends("AT+CLPORT=\"TCP\",\"2022\"\r\n");//ָָض˿
 218   3                              DelaySec(1);
 219   3                              Uart1Sends("AT+CIPSTART=\"TCP\",\"120.27.96.78\",\"8888\"\r\n");//˴޸㽨IP˿ں
             -8080
 220   3                              DelaySec(1);
 221   3                              GsmJiFlag = 1;
 222   3                              GsmLiFlag = 1;
 223   3                              break;
 224   3                      }               
 225   2              }
 226   1      
 227   1              while(1)
 228   1              {       
 229   2                       if (CanRead == 1)         //ʵʱӦյĿָ
 230   2                       {
 231   3                                CanRead = 0;
 232   3                                P1 = 0x00;
 233   3                                DelaySec(1);
 234   3                                P1 = 0xff;
 235   3                       }
 236   2              }
 237   1      }


C51 COMPILER V9.01   GSM                                                                   12/06/2016 11:26:04 PAGE 5   

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    573    ----
   CONSTANT SIZE    =    147    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =    100       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
